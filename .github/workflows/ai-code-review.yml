name: AI Code Review for Kotlin Migration

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'backend/**/*.java'
      - 'backend/**/*.kt'
      - 'backend/**/*.kts'
      - 'backend/build.gradle.kts'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });
            
            // Java와 Kotlin 파일 필터링
            const reviewableFiles = diff.data.files.filter(file => 
              (file.filename.endsWith('.java') || 
               file.filename.endsWith('.kt') || 
               file.filename.endsWith('.kts')) && 
              file.patch &&
              file.status !== 'removed'
            );
            
            if (reviewableFiles.length === 0) {
              console.log('No reviewable files found');
              return;
            }
            
            const fileReviews = [];
            const javaToKotlinMigration = [];
            
            // 파일별 리뷰 (최대 5개)
            for (const file of reviewableFiles.slice(0, 5)) {
              const fileType = file.filename.endsWith('.java') ? 'Java' : 'Kotlin';
              const isNewFile = file.status === 'added';
              
              // Java 파일과 동일한 경로의 Kotlin 파일 체크 (마이그레이션 감지)
              const baseFilename = file.filename.replace(/\.(java|kt)$/, '');
              const isMigration = reviewableFiles.some(f => 
                f.filename.replace(/\.(java|kt)$/, '') === baseFilename && 
                f.filename !== file.filename
              );
              
              if (isMigration && fileType === 'Kotlin') {
                javaToKotlinMigration.push(file.filename);
              }
              
              try {
                // 전체 파일 내용 가져오기 (신규 파일이거나 변경이 큰 경우)
                let fileContent = '';
                try {
                  const fileResponse = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: file.filename,
                    ref: context.payload.pull_request.head.sha
                  });
                  
                  if (fileResponse.data.content) {
                    fileContent = Buffer.from(fileResponse.data.content, 'base64').toString();
                  }
                } catch (e) {
                  console.log(`Could not fetch full content for ${file.filename}`);
                }
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'deepseek/deepseek-r1-0528:free',
                    messages: [{
                      role: 'system',
                      content: `당신은 Spring Boot와 Kotlin 마이그레이션 전문가입니다.
                      ${isMigration ? 'Java에서 Kotlin으로 마이그레이션된 코드를 검토합니다.' : '코드 변경사항을 리뷰합니다.'}
                      
                      리뷰 포맷 (구체적인 코드 예시 포함):
                      🟢 **좋은 점**
                      - 구체적인 장점과 코드 예시
                      
                      🟡 **개선 제안** 
                      - 개선 가능한 부분과 수정 코드 예시
                      
                      🔴 **필수 수정**
                      - 반드시 수정해야 할 부분과 수정 코드
                      
                      ${fileType === 'Kotlin' ? `
                      Kotlin 체크포인트:
                      - Data class 변환 가능 여부
                      - Nullable 타입 활용도
                      - 스코프 함수 사용 적절성
                      - 컬렉션 연산 최적화
                      - Java 호환성 어노테이션
                      ` : ''}
                      
                      코드의 특정 부분을 언급하며 구체적인 피드백을 제공하세요.`
                    }, {
                      role: 'user',
                      content: `파일: ${file.filename}
                      타입: ${fileType} ${isNewFile ? '(새 파일)' : '(수정)'}
                      ${isMigration ? '⚡ Java → Kotlin 마이그레이션' : ''}
                      
                      ${fileContent ? `전체 코드:
                      \`\`\`${fileType.toLowerCase()}
                      ${fileContent.substring(0, 3000)}${fileContent.length > 3000 ? '\n... (truncated)' : ''}
                      \`\`\`
                      ` : ''}
                      
                      변경사항:
                      \`\`\`diff
                      ${file.patch || 'No patch available'}
                      \`\`\``
                    }],
                    max_tokens: 1500,
                    temperature: 0.3
                  })
                });
                
                if (response.ok) {
                  const result = await response.json();
                  const review = result.choices[0]?.message?.content || '리뷰를 생성할 수 없습니다.';
                  
                  fileReviews.push({
                    filename: file.filename,
                    review: review,
                    fileType: fileType,
                    isMigration: isMigration
                  });
                  
                  console.log(`Successfully reviewed ${file.filename}`);
                } else {
                  console.error(`API error for ${file.filename}:`, response.status);
                }
              } catch (error) {
                console.error(`Error reviewing ${file.filename}:`, error);
                fileReviews.push({
                  filename: file.filename,
                  review: '⚠️ 리뷰 생성 중 오류가 발생했습니다.',
                  fileType: fileType,
                  isMigration: isMigration
                });
              }
            }
            
            // PR 리뷰 작성
            if (fileReviews.length > 0) {
              let reviewBody = `# 🤖 AI Code Review - Kotlin Migration\n\n`;
              
              // 마이그레이션 파일이 있는 경우
              if (javaToKotlinMigration.length > 0) {
                reviewBody += `## 🔄 Java → Kotlin 마이그레이션 감지\n\n`;
                reviewBody += `다음 파일들이 Kotlin으로 마이그레이션되었습니다:\n`;
                javaToKotlinMigration.forEach(f => {
                  reviewBody += `- ✅ \`${f}\`\n`;
                });
                reviewBody += `\n---\n\n`;
              }
              
              // 파일별 상세 리뷰
              reviewBody += `## 📝 상세 리뷰\n\n`;
              for (const fileReview of fileReviews) {
                reviewBody += `### \`${fileReview.filename}\` `;
                reviewBody += fileReview.isMigration ? `🔄 (마이그레이션)` : `(${fileReview.fileType})`;
                reviewBody += `\n\n${fileReview.review}\n\n`;
              }
              
              // 마이그레이션 체크리스트 (Kotlin 파일이 있는 경우)
              const hasKotlinFiles = fileReviews.some(r => r.fileType === 'Kotlin');
              if (hasKotlinFiles) {
                reviewBody += `---\n\n## ✅ Kotlin 마이그레이션 체크리스트\n\n`;
                reviewBody += `- [ ] Null safety 적절히 활용됨\n`;
                reviewBody += `- [ ] Data class로 변환 가능한 부분 확인\n`;
                reviewBody += `- [ ] Extension functions 활용 검토\n`;
                reviewBody += `- [ ] Collection operations 최적화\n`;
                reviewBody += `- [ ] Java 상호운용성 확인\n`;
                reviewBody += `- [ ] 테스트 코드 마이그레이션 필요성 검토\n\n`;
              }
              
              // 푸터
              reviewBody += `---\n\n`;
              reviewBody += `> 🤖 **Model**: DeepSeek R1 (deepseek-r1-0528:free)\n`;
              reviewBody += `> 📊 **검토 파일**: ${fileReviews.length}/${reviewableFiles.length}개\n`;
              reviewBody += `> 🏷️ **Mode**: Kotlin Migration Review\n`;
              
              // 리뷰 생성
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: reviewBody,
                event: 'COMMENT'
              });
              
              // 라벨 추가 시도
              if (javaToKotlinMigration.length > 0) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    labels: ['kotlin-migration']
                  });
                } catch (e) {
                  console.log('Label addition failed (labels might not exist)');
                }
              }
            }