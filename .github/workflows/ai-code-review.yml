name: AI Code Review for Kotlin Migration

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'backend/**/*.java'
      - 'backend/**/*.kt'
      - 'backend/**/*.kts'
      - 'backend/build.gradle.kts'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });
            
            // Javaì™€ Kotlin íŒŒì¼ í•„í„°ë§
            const reviewableFiles = diff.data.files.filter(file => 
              (file.filename.endsWith('.java') || 
               file.filename.endsWith('.kt') || 
               file.filename.endsWith('.kts')) && 
              file.patch &&
              file.status !== 'removed'
            );
            
            if (reviewableFiles.length === 0) {
              console.log('No reviewable files found');
              return;
            }
            
            const fileReviews = [];
            const javaToKotlinMigration = [];
            
            // íŒŒì¼ë³„ ë¦¬ë·° (ìµœëŒ€ 5ê°œ)
            for (const file of reviewableFiles.slice(0, 5)) {
              const fileType = file.filename.endsWith('.java') ? 'Java' : 'Kotlin';
              const isNewFile = file.status === 'added';
              
              // Java íŒŒì¼ê³¼ ë™ì¼í•œ ê²½ë¡œì˜ Kotlin íŒŒì¼ ì²´í¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€)
              const baseFilename = file.filename.replace(/\.(java|kt)$/, '');
              const isMigration = reviewableFiles.some(f => 
                f.filename.replace(/\.(java|kt)$/, '') === baseFilename && 
                f.filename !== file.filename
              );
              
              if (isMigration && fileType === 'Kotlin') {
                javaToKotlinMigration.push(file.filename);
              }
              
              try {
                // ì „ì²´ íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (ì‹ ê·œ íŒŒì¼ì´ê±°ë‚˜ ë³€ê²½ì´ í° ê²½ìš°)
                let fileContent = '';
                try {
                  const fileResponse = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: file.filename,
                    ref: context.payload.pull_request.head.sha
                  });
                  
                  if (fileResponse.data.content) {
                    fileContent = Buffer.from(fileResponse.data.content, 'base64').toString();
                  }
                } catch (e) {
                  console.log(`Could not fetch full content for ${file.filename}`);
                }
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    model: 'deepseek/deepseek-r1-0528:free',
                    messages: [{
                      role: 'system',
                      content: `ë‹¹ì‹ ì€ Spring Bootì™€ Kotlin ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.
                      ${isMigration ? 'Javaì—ì„œ Kotlinìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ì½”ë“œë¥¼ ê²€í† í•©ë‹ˆë‹¤.' : 'ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•©ë‹ˆë‹¤.'}
                      
                      ë¦¬ë·° í¬ë§· (êµ¬ì²´ì ì¸ ì½”ë“œ ì˜ˆì‹œ í¬í•¨):
                      ðŸŸ¢ **ì¢‹ì€ ì **
                      - êµ¬ì²´ì ì¸ ìž¥ì ê³¼ ì½”ë“œ ì˜ˆì‹œ
                      
                      ðŸŸ¡ **ê°œì„  ì œì•ˆ** 
                      - ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„ê³¼ ìˆ˜ì • ì½”ë“œ ì˜ˆì‹œ
                      
                      ðŸ”´ **í•„ìˆ˜ ìˆ˜ì •**
                      - ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•  ë¶€ë¶„ê³¼ ìˆ˜ì • ì½”ë“œ
                      
                      ${fileType === 'Kotlin' ? `
                      Kotlin ì²´í¬í¬ì¸íŠ¸:
                      - Data class ë³€í™˜ ê°€ëŠ¥ ì—¬ë¶€
                      - Nullable íƒ€ìž… í™œìš©ë„
                      - ìŠ¤ì½”í”„ í•¨ìˆ˜ ì‚¬ìš© ì ì ˆì„±
                      - ì»¬ë ‰ì…˜ ì—°ì‚° ìµœì í™”
                      - Java í˜¸í™˜ì„± ì–´ë…¸í…Œì´ì…˜
                      ` : ''}
                      
                      ì½”ë“œì˜ íŠ¹ì • ë¶€ë¶„ì„ ì–¸ê¸‰í•˜ë©° êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”.`
                    }, {
                      role: 'user',
                      content: `íŒŒì¼: ${file.filename}
                      íƒ€ìž…: ${fileType} ${isNewFile ? '(ìƒˆ íŒŒì¼)' : '(ìˆ˜ì •)'}
                      ${isMigration ? 'âš¡ Java â†’ Kotlin ë§ˆì´ê·¸ë ˆì´ì…˜' : ''}
                      
                      ${fileContent ? `ì „ì²´ ì½”ë“œ:
                      \`\`\`${fileType.toLowerCase()}
                      ${fileContent.substring(0, 3000)}${fileContent.length > 3000 ? '\n... (truncated)' : ''}
                      \`\`\`
                      ` : ''}
                      
                      ë³€ê²½ì‚¬í•­:
                      \`\`\`diff
                      ${file.patch || 'No patch available'}
                      \`\`\``
                    }],
                    max_tokens: 1500,
                    temperature: 0.3
                  })
                });
                
                if (response.ok) {
                  const result = await response.json();
                  const review = result.choices[0]?.message?.content || 'ë¦¬ë·°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                  
                  fileReviews.push({
                    filename: file.filename,
                    review: review,
                    fileType: fileType,
                    isMigration: isMigration
                  });
                  
                  console.log(`Successfully reviewed ${file.filename}`);
                } else {
                  console.error(`API error for ${file.filename}:`, response.status);
                }
              } catch (error) {
                console.error(`Error reviewing ${file.filename}:`, error);
                fileReviews.push({
                  filename: file.filename,
                  review: 'âš ï¸ ë¦¬ë·° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                  fileType: fileType,
                  isMigration: isMigration
                });
              }
            }
            
            // PR ë¦¬ë·° ìž‘ì„±
            if (fileReviews.length > 0) {
              let reviewBody = `# ðŸ¤– AI Code Review - Kotlin Migration\n\n`;
              
              // ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìžˆëŠ” ê²½ìš°
              if (javaToKotlinMigration.length > 0) {
                reviewBody += `## ðŸ”„ Java â†’ Kotlin ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€\n\n`;
                reviewBody += `ë‹¤ìŒ íŒŒì¼ë“¤ì´ Kotlinìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤:\n`;
                javaToKotlinMigration.forEach(f => {
                  reviewBody += `- âœ… \`${f}\`\n`;
                });
                reviewBody += `\n---\n\n`;
              }
              
              // íŒŒì¼ë³„ ìƒì„¸ ë¦¬ë·°
              reviewBody += `## ðŸ“ ìƒì„¸ ë¦¬ë·°\n\n`;
              for (const fileReview of fileReviews) {
                reviewBody += `### \`${fileReview.filename}\` `;
                reviewBody += fileReview.isMigration ? `ðŸ”„ (ë§ˆì´ê·¸ë ˆì´ì…˜)` : `(${fileReview.fileType})`;
                reviewBody += `\n\n${fileReview.review}\n\n`;
              }
              
              // ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Kotlin íŒŒì¼ì´ ìžˆëŠ” ê²½ìš°)
              const hasKotlinFiles = fileReviews.some(r => r.fileType === 'Kotlin');
              if (hasKotlinFiles) {
                reviewBody += `---\n\n## âœ… Kotlin ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n`;
                reviewBody += `- [ ] Null safety ì ì ˆížˆ í™œìš©ë¨\n`;
                reviewBody += `- [ ] Data classë¡œ ë³€í™˜ ê°€ëŠ¥í•œ ë¶€ë¶„ í™•ì¸\n`;
                reviewBody += `- [ ] Extension functions í™œìš© ê²€í† \n`;
                reviewBody += `- [ ] Collection operations ìµœì í™”\n`;
                reviewBody += `- [ ] Java ìƒí˜¸ìš´ìš©ì„± í™•ì¸\n`;
                reviewBody += `- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”ì„± ê²€í† \n\n`;
              }
              
              // í‘¸í„°
              reviewBody += `---\n\n`;
              reviewBody += `> ðŸ¤– **Model**: DeepSeek R1 (deepseek-r1-0528:free)\n`;
              reviewBody += `> ðŸ“Š **ê²€í†  íŒŒì¼**: ${fileReviews.length}/${reviewableFiles.length}ê°œ\n`;
              reviewBody += `> ðŸ·ï¸ **Mode**: Kotlin Migration Review\n`;
              
              // ë¦¬ë·° ìƒì„±
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: reviewBody,
                event: 'COMMENT'
              });
              
              // ë¼ë²¨ ì¶”ê°€ ì‹œë„
              if (javaToKotlinMigration.length > 0) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    labels: ['kotlin-migration']
                  });
                } catch (e) {
                  console.log('Label addition failed (labels might not exist)');
                }
              }
            }